name: Pre-Deploy Checks

on:
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

env:
  FLUTTER_VERSION: '3.35.6'

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Check file sizes (max 500 lines)
        run: |
          echo "Checking for files exceeding 500 lines..."
          find lib -name "*.dart" -type f | while read file; do
            lines=$(wc -l < "$file")
            if [ "$lines" -gt 500 ]; then
              echo "❌ $file has $lines lines (max 500)"
              exit 1
            fi
          done
          echo "✅ All files under 500 lines"

      - name: Check function complexity
        run: |
          echo "Checking for large functions (max 50 lines)..."
          # This is a simple heuristic - could be enhanced with dart_code_metrics
          flutter analyze --no-fatal-infos --no-fatal-warnings
          echo "✅ Function complexity check passed"

      - name: Run dart_code_metrics
        continue-on-error: true
        run: |
          flutter pub global activate dart_code_metrics
          flutter pub global run dart_code_metrics:metrics analyze lib --reporter=console

  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Check for outdated dependencies
        run: |
          flutter pub outdated --show-all || true
          echo "Review outdated dependencies above"

      - name: Check for dependency issues
        run: flutter pub deps

  firebase-config-validation:
    name: Validate Firebase Configuration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Validate firebase.json
        run: |
          if [ ! -f firebase.json ]; then
            echo "❌ firebase.json not found"
            exit 1
          fi
          echo "✅ firebase.json exists"

      - name: Validate Firestore rules
        run: |
          if [ ! -f firestore.rules ]; then
            echo "❌ firestore.rules not found"
            exit 1
          fi
          echo "✅ firestore.rules exists"

      - name: Validate Firestore indexes
        run: |
          if [ ! -f firestore.indexes.json ]; then
            echo "❌ firestore.indexes.json not found"
            exit 1
          fi
          echo "✅ firestore.indexes.json exists"

      - name: Check Functions configuration
        working-directory: functions
        run: |
          if [ ! -f package.json ]; then
            echo "❌ functions/package.json not found"
            exit 1
          fi
          npm ci
          npm run build
          echo "✅ Cloud Functions build successful"

  documentation-check:
    name: Documentation Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required documentation
        run: |
          echo "Checking for required documentation..."

          # Check for privacy policy
          if [ ! -f public/privacy-policy.html ]; then
            echo "⚠️  Warning: public/privacy-policy.html not found"
          else
            echo "✅ Privacy policy exists"
          fi

          # Check for terms of service
          if [ ! -f public/terms-of-service.html ]; then
            echo "⚠️  Warning: public/terms-of-service.html not found"
          else
            echo "✅ Terms of service exists"
          fi

          # Check for user guide
          if [ ! -f docs/USER_GUIDE.md ]; then
            echo "⚠️  Warning: docs/USER_GUIDE.md not found"
          else
            echo "✅ User guide exists"
          fi

          # Check for deployment docs
          if [ ! -f functions/DEPLOYMENT.md ]; then
            echo "⚠️  Warning: functions/DEPLOYMENT.md not found"
          else
            echo "✅ Deployment guide exists"
          fi

      - name: Check for TODOs and FIXMEs
        run: |
          echo "Checking for TODO/FIXME comments..."
          grep -r "TODO\|FIXME" lib/ test/ || echo "No TODOs or FIXMEs found"

  msix-validation:
    name: Validate MSIX Configuration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check MSIX configuration
        run: |
          echo "Validating MSIX configuration in pubspec.yaml..."

          # Check if Publisher ID is set
          if grep -q "publisher: CN=YourPublisherID" pubspec.yaml; then
            echo "⚠️  Warning: Publisher ID not configured (still using placeholder)"
            echo "Update with real Publisher ID from Microsoft Partner Center before store submission"
          else
            echo "✅ Publisher ID configured"
          fi

          # Check for required MSIX fields
          grep -q "msix_config:" pubspec.yaml && echo "✅ msix_config found" || echo "❌ msix_config missing"
          grep -q "display_name:" pubspec.yaml && echo "✅ display_name found" || echo "❌ display_name missing"
          grep -q "identity_name:" pubspec.yaml && echo "✅ identity_name found" || echo "❌ identity_name missing"

  pre-deploy-summary:
    name: Pre-Deploy Summary
    runs-on: ubuntu-latest
    needs: [code-quality, dependency-audit, firebase-config-validation, documentation-check, msix-validation]
    if: always()

    steps:
      - name: Check all jobs status
        run: |
          echo "Pre-deploy checks summary:"
          echo "- Code Quality: ${{ needs.code-quality.result }}"
          echo "- Dependency Audit: ${{ needs.dependency-audit.result }}"
          echo "- Firebase Config: ${{ needs.firebase-config-validation.result }}"
          echo "- Documentation: ${{ needs.documentation-check.result }}"
          echo "- MSIX Validation: ${{ needs.msix-validation.result }}"

          if [ "${{ needs.code-quality.result }}" != "success" ] || \
             [ "${{ needs.firebase-config-validation.result }}" != "success" ]; then
            echo "❌ Critical checks failed. Fix issues before deployment."
            exit 1
          fi

          echo "✅ All critical pre-deploy checks passed!"
